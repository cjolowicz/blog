---
title: "Hosting a Hugo blog on GitHub Pages with Travis CI"
date: 2019-04-27T10:48:29+02:00
---

This post describes how to set up a blog using
[Hugo](https://gohugo.io/), an open-source static site generator. The
blog will be hosted on [GitHub Pages](https://pages.github.com/), a
web hosting service offered by GitHub. The
[Travis CI](https://travis-ci.com) continuous integration service is
used to deploy changes to the blog.

> This post is partially based on Artem Sidorenko's article
> [Hugo on GitHub Pages with Travis CI](https://www.sidorenko.io/post/2018/12/hugo-on-github-pages-with-travis-ci/).

## Overview

We will set up two separate GitHub repositories. The first repository
will be named _blog_ and hold the Hugo sources. The second repository
will be named _username.github.io_, and hold the generated content.

When you push a change to _blog_, Travis CI will invoke `hugo` to
rebuild the site, and push the generated content to
_username.github.io_. GitHub Pages will then deploy the site to
https://username.github.io/.

Throughout this post, replace `username` with your GitHub username.

## Setting up the blog repository

In this section we will install Hugo and set up the blog repository on
GitHub. We install Hugo using [Homebrew](https://brew.sh/) on macOS.

```sh
# Install hugo.
brew install hugo

# Create the blog.
hugo new site blog
cd blog

# Create the repository.
git init
git add .
git commit -m "Initial commit"
```

The next step is to install a theme. For now, we stick with the
[ananke](https://themes.gohugo.io/gohugo-theme-ananke/) theme
recommended in Hugo's Quick Start tutorial. We also make use of
[git submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules),
allowing us to track upstream changes to the theme.

```sh
# Install a theme.
git submodule add \
    https://github.com/budparr/gohugo-theme-ananke.git \
    themes/ananke
git commit -am "Add submodule themes/ananke"
```

Hugo is configured using a file called `config.toml`, which has
already been generated for us. Edit this file to configure the site
URL and the blog title, replacing `username` by your GitHub
username. We also declare the theme we just installed.

```toml
baseURL = "http://username.github.io/"
languageCode = "en-us"
title = "My Blog"
theme = "ananke"
```

Blog posts can be written using Markdown syntax with a YAML preamble
called _front-matter_. Use the Hugo CLI to generate an initial file:

```sh
hugo new posts/my-first-post.md
```

The generated file is located at `content/posts/my-first-post.md` and
looks something like this:

```yaml
---
title: "My First Post"
date: 2019-04-27T10:48:29+02:00
draft: true
---

```

Use your favorite editor to write the actual post. Remove the `draft`
line from the front-matter when the post is ready to be published.

After committing your changes, publish the repository to GitHub. One
convenient way to do so is using [hub](https://github.com/github/hub),
a command-line tool for managing GitHub repositories:

```sh
brew install hub
hub create
git push origin master
```

## Setting up the github.io repository

We will now set up another repository, named `username.github.io`.
This repository will hold the static content generated by Hugo. This
content will be deployed automatically to the site located at
https://username.github.io/ by GitHub Pages.

```sh
mkdir username.github.io
cd username.github.io

git init
echo "# username.github.io" > README.md

git add .
git commit -m "Initial commit"

hub create
git push origin master
```

Note that we have created the repository with an initial commit.  An
empty repository cannot be added as a submodule, which is what we are
about to do now.

Return to the _blog_ repository, and invoke the following commands in
its top-level directory:

```sh
git submodule add \
    https://github.com/username/username.github.io.git \
    public
git commit -am "Add submodule public"
```

The _public_ directory is where Hugo generates the content. Adding the
_username.github.io_ repository as a submodule at this exact location
simplifies getting the generated content into this repository.

## Continuous Deployment

We can now start to think about Continous Deployment. Deploying a
change such as a new post to the live blog requires several steps:

1. The change is pushed to the _blog_ repository.
2. Hugo is triggered to rebuild the site content in _public_.
3. The changes to _public_ are pushed to the _username.github.io_
   repository.
4. The _username.github.io_ repository is deployed to GitHub Pages.

The last step---deploying from _username.github.io_ to GitHub
Pages---does not require any further setup, because the repository
name is treated specially.

Generating the content and pushing it to _username.github.io_ is not
automatic yet, however. We will set up continuous integration on the
_blog_ repository to achieve this using
[Travis CI](https://travis-ci.com) with a separate bot account.

### Setting up a bot account

Travis CI will need write access to the _username.github.io_
repository to be able to push to it. Instead of granting it access to
our personal GitHub account, we will set up a separate bot account
with collaborator access to the repository.

Create a GitHub account named `username-blog-bot`, replacing
`username` by your GitHub username. This is just a normal GitHub user
account and can be created using GitHub's
[SignUp](https://github.com/join) page, after logging out of your
personal account.

When you're done setting up the GitHub account, add the bot account as
a collaborator to the `username.github.io` repository, using the
Settings page for the repository.

### Setting up Travis CI

On Travis CI, go to the Setting page for the `blog` repository, and
add an environment variable `GITHUB_AUTH_SECRET` with the value
`https://username-blog-bot:xxxxxx@github.com`.

Replace `username` by your GitHub username, and `xxxxxx` by the
password of the bot account. Ensure that the _Display value in build
log_ switch is in the off position.

The CI job is configured using the file `.travis.yml` in the _blog_
repository:

```yaml
---
install:
  - curl -LO https://github.com/gohugoio/hugo/releases/download/v0.55.4/hugo_0.55.4_Linux-64bit.deb
  - sudo dpkg -i hugo_0.55.4_Linux-64bit.deb

script:
  - hugo

deploy:
  - provider: script
    script: ./deploy.sh
    skip_cleanup: true
    on:
      branch: master
```

This will invoke `hugo` to generate the static content, and a script
`deploy.sh` to push the changes into the _username.github.io_
repository.

Note that `skip_cleanup: true` is required so that Travis does not
remove the generated files before running the `deploy` step.

Create the script `deploy.sh` in the _blog_ repository, again
replacing `username` with your GitHub username:

```sh
#!/bin/bash

echo -e "\033[0;32mDeploying updates to GitHub...\033[0m"

cd public

if [ -n "$GITHUB_AUTH_SECRET" ]
then
    touch ~/.git-credentials
    chmod 0600 ~/.git-credentials
    echo $GITHUB_AUTH_SECRET > ~/.git-credentials

    git config credential.helper store
    git config user.email "username-blog-bot@users.noreply.github.com"
    git config user.name "username-blog-bot"
fi

git add .
git commit -m "Rebuild site"
git push --force origin HEAD:master
```

### Remarks

Here are some remarks about the subtleties of this CI setup. You can
skip down to the next section, if you're eager to finish setting up
your blog.

First, note that we force-push the generated content, effectively
replacing the `HEAD` commit and effacing history. This is no big deal,
as we're only dealing with generated content here.

The reason for force-pushing is somewhat subtle: Travis CI checks out
the repository in detached HEAD mode, so we cannot easily pull the
previous content. This is also why the last argument to the push
command is `HEAD:master` rather than `master`.

Also, committing to the submodule leaves the main repository in a
dirty state. CI never updates the main repository to point to the new
commit in its submodule. It cannot, because the bot account does not
have write access to the _blog_ repository.

This is also not really an issue, because our site is deployed
directly from _username.github.io_, rather than from the _blog_
repository's submodule.

## Finishing

Finally, commit these changes and push them to the _blog_ repository.

```sh
git add .travis.yml deploy.sh
git commit -am "CI: Build and push to username.github.io"
```

You can now visit https://travis-ci.com/USERNAME/blog to see your blog
building. When CI has completed, your blog should be live at
https://username.github.io/.

## Links
- https://gohugo.io/getting-started/quick-start/
- https://gohugo.io/hosting-and-deployment/hosting-on-github/
- https://www.sidorenko.io/post/2018/12/hugo-on-github-pages-with-travis-ci/
