--- 
date: 2019-11-07T12:52:59+02:00
title: "Hypermodern Python 4: Typing"
description: "Coding in Python like Savielly Tartakower."
draft: true
tags:
  - python
  - pytype
  - nox
  - GitHub Actions
---

In this fourth installment of the Hypermodern Python series, I'm going to
discuss how to add static type checking to your project.

For your reference, below is a list of the articles in this series.

- [Chapter 1: Setup](../hypermodern-python-01-setup)
- [Chapter 2: Testing](../hypermodern-python-02-testing)
- [Chapter 3: Linting](../hypermodern-python-03-linting)
- [Chapter 4: Typing](../hypermodern-python-04-typing)
- [Chapter 5: Documentation](../hypermodern-python-05-documentation)
- [Chapter 6: CI/CD](../hypermodern-python-05-ci-cd)

<!--
This post has a companion repository:
[cjolowicz/hypermodern-python](https://github.com/cjolowicz/hypermodern-python)
-->

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**In this chapter:**

- [Static type checking with pytype](#static-type-checking-with-pytype)
- [Increasing type coverage with flake8-annotations](#increasing-type-coverage-with-flake8-annotations)

<!-- markdown-toc end -->

## Static type checking with pytype

With the advent of [type
annotations](https://docs.python.org/3/library/typing.html), several static type
checkers for Python have come into existence: [mypy](http://mypy-lang.org/),
Google's [pytype](https://google.github.io/pytype/), and Microsoft's
[pyright](https://github.com/microsoft/pyright). In contrast to other type
checkers, pytype is able to infer types for unannotated code.

Add the following session to `noxfile.py` to add `pytype`:

```python
# noxfile.py
@nox.session(python="3.7")
def pytype(session):
    """Run the static type checker."""
    args = session.posargs or locations
    session.install("pytype")
    session.run("pytype", *args)
```

This session runs in Python 3.7 only, because Python 3.8 is [not yet
supported](https://github.com/google/pytype/issues/440) in pytype.

Some third-party packages are distributed without type annotations, resulting in
import errors reported by pytype. You could add a `# pytype:
disable=import-error` comment to the `import` statements of offending packages,
but this can get pretty repetitive. Instead, create the `pytype.cfg`
configuration file and disable import errors globally:

```ini
# pytype.cfg
[pytype]
disable = import-error
```

You need to specify the configuration file explicitly when invoking pytype:

```python
# noxfile.py
@nox.session(python="3.7")
def pytype(session):
    """Run the static type checker."""
    args = session.posargs or locations
    session.install("pytype")
    session.run("pytype", "--config=pytype.cfg", *args)
```

With this in place, the static checker should be happy with the current state of
affairs:

```sh
nox -rs pytype
```

Update `nox.options.session` to include static type checking in the default Nox
sessions:

```python
nox.options.sessions = "lint", "pytype", "tests"
```

## Adding type annotations

While pytype uses type inference to validate Python code even in the absence of
type annotations, it can clearly perform a much better job if you add [type
annotations](https://docs.python.org/3/library/typing.html) to your codebase.

The `splines.reticulate` function accepts an optional `int`, and yields values
of type `int`. The local variable `spline` is also an `int`.

```python
# src/hypermodern_python/splines.py
import time
from typing import Iterator


def reticulate(count: int = -1) -> Iterator[int]:
    spline: int = 0
    while count < 0 or spline < count:
        time.sleep(1)
        spline += 1
        yield spline
```

The `console.main` function looks scary with its many decorators. But at its
core, it is a simple function accepting an `int` and returning `None`.

```python
# src/hypermodern_python/console.py
def main(count: int) -> None:
    ...
```

## Increasing type coverage with flake8-annotations

[flake8-annotations](https://github.com/python-discord/flake8-annotations) is a
flake8 plugin that detects the absence of type annotations for functions.

Install the plugin into the linting session:

```python
# noxfile.py
...
def lint(session):
    ...
    session.install("flake8", "flake8-black", "flake8-annotations")
    ...
```

Enable the warnings generated by the plugin, which are prefixed by `TYP`:

```ini
# .flake8
select = BLK,C,E,F,TYP,W
```

If you run `nox -rs lint` again, the plugin will spew out a multitude of
warnings about functions lacking type information in `noxfile.py` and the test
suite.

You can disable warnings for these locations as follows:

Alternatively, if you prefer to annotate the Nox sessions and test suite, this
is how you would do it:

```python
# noxfile.py
def black(session: nox.sessions.Session) -> None:
def lint(session: nox.sessions.Session) -> None:
def tests(session: nox.sessions.Session) -> None:
def coverage(session: nox.sessions.Session) -> None:

# tests/conftest.py
import unittest.mock
import pytest_mock
def mock_sleep(mocker: pytest_mock.MockFixture) -> unittest.mock.Mock:

# tests/test_console.py
import unittest.mock
def runner() -> click.testing.CliRunner:
def test_help_succeeds(runner: click.testing.CliRunner) -> None:
def test_main_prints_progress_message(
    runner: click.testing.CliRunner, mock_sleep: unittest.mock.Mock
) -> None:

# tests/test_splines.py
import unittest.mock
def test_reticulate_sleeps(mock_sleep: unittest.mock.Mock) -> None:
def test_reticulate_yields_count_times(mock_sleep: unittest.mock.Mock) -> None:
```

<center>[Continue to the next chapter](../hypermodern-python-05-documentation)</center>
